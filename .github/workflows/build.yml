name: Build and Release
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  release:
    types: [ published ]
  workflow_dispatch:
jobs:
  build:
    strategy:
      matrix:
        os: [windows-latest, ubuntu-latest, macos-latest]
        include:
          - os: windows-latest
            runtime: win-x64
            extension: .exe
            os_name: Windows
          - os: ubuntu-latest
            runtime: linux-x64
            extension: ""
            os_name: Linux
          - os: macos-latest
            runtime: osx-x64
            extension: ""
            os_name: Mac
    runs-on: ${{ matrix.os }}
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 8.0.x
    
    - name: Restore dependencies
      run: dotnet restore
    
    - name: Build
      run: dotnet build --no-restore --configuration Release
    
    # Windows and Linux - single file
    - name: Publish (Windows/Linux)
      if: matrix.os != 'macos-latest'
      run: |
        dotnet publish --configuration Release --runtime ${{ matrix.runtime }} --self-contained true --output ./build -p:PublishSingleFile=true -p:IncludeNativeLibrariesForSelfExtract=true
    
    # macOS - self-contained but NOT single file to avoid native lib issues
    - name: Publish macOS (Self-Contained Multi-File)
      if: matrix.os == 'macos-latest'
      run: |
        dotnet publish --configuration Release --runtime ${{ matrix.runtime }} --self-contained true --output ./build-temp -p:IncludeNativeLibrariesForSelfExtract=true -p:PublishTrimmed=false
        
        # Create app bundle
        APP_NAME="Symphex"
        BUNDLE_NAME="$APP_NAME.app"
        
        mkdir -p "./build/$BUNDLE_NAME/Contents/MacOS"
        mkdir -p "./build/$BUNDLE_NAME/Contents/Resources"
        
        # Copy all published files
        cp -r ./build-temp/* "./build/$BUNDLE_NAME/Contents/MacOS/"
        
        # Create Info.plist
        cat > "./build/$BUNDLE_NAME/Contents/Info.plist" << 'EOF'
        <?xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
        <plist version="1.0">
        <dict>
            <key>CFBundleExecutable</key>
            <string>Symphex</string>
            <key>CFBundleIdentifier</key>
            <string>com.symphex.app</string>
            <key>CFBundleName</key>
            <string>Symphex</string>
            <key>CFBundleDisplayName</key>
            <string>Symphex</string>
            <key>CFBundleVersion</key>
            <string>1.0.0</string>
            <key>CFBundleShortVersionString</key>
            <string>1.0.0</string>
            <key>CFBundlePackageType</key>
            <string>APPL</string>
            <key>LSMinimumSystemVersion</key>
            <string>10.15</string>
            <key>NSHighResolutionCapable</key>
            <true/>
            <key>LSUIElement</key>
            <false/>
            <key>NSAppTransportSecurity</key>
            <dict>
                <key>NSAllowsArbitraryLoads</key>
                <true/>
            </dict>
        </dict>
        </plist>
        EOF
        
        # Set permissions for everything
        chmod +x "./build/$BUNDLE_NAME/Contents/MacOS/Symphex"
        find "./build/$BUNDLE_NAME/Contents/MacOS" -name "*.dylib" -exec chmod +x {} \;
        find "./build/$BUNDLE_NAME/Contents/MacOS" -name "*.so" -exec chmod +x {} \;
        
        # Create entitlements file for proper signing
        cat > "./entitlements.plist" << 'EOF'
        <?xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
        <plist version="1.0">
        <dict>
            <key>com.apple.security.cs.allow-jit</key>
            <true/>
            <key>com.apple.security.cs.allow-unsigned-executable-memory</key>
            <true/>
            <key>com.apple.security.cs.allow-dyld-environment-variables</key>
            <true/>
            <key>com.apple.security.cs.disable-library-validation</key>
            <true/>
        </dict>
        </plist>
        EOF
        
        # Ad-hoc sign everything individually first
        find "./build/$BUNDLE_NAME/Contents/MacOS" -name "*.dylib" -exec codesign --force --sign - --options=runtime --entitlements ./entitlements.plist {} \;
        codesign --force --sign - --options=runtime --entitlements ./entitlements.plist "./build/$BUNDLE_NAME/Contents/MacOS/Symphex"
        
        # Then sign the entire app bundle
        codesign --force --deep --sign - --options=runtime --entitlements ./entitlements.plist "./build/$BUNDLE_NAME"
        
        # Remove quarantine attributes just in case
        xattr -cr "./build/$BUNDLE_NAME" 2>/dev/null || true
        
        rm -rf ./build-temp
        rm ./entitlements.plist
    
    - name: Set executable permissions (Linux)
      if: matrix.os == 'ubuntu-latest'
      run: |
        chmod +x ./build/Symphex
    
    - name: Create Archive (Windows)
      if: matrix.os == 'windows-latest'
      shell: powershell
      run: |
        Compress-Archive -Path ./build/* -DestinationPath ${{ matrix.os_name }}.zip
    
    - name: Create Archive (Linux)
      if: matrix.os == 'ubuntu-latest'
      run: |
        cd build && zip -r ../${{ matrix.os_name }}.zip .
        
    - name: Create Archive (macOS)
      if: matrix.os == 'macos-latest'
      run: |
        cd build && zip -r ../${{ matrix.os_name }}.zip Symphex.app
    
    - name: Upload Build Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.os_name }}
        path: ./${{ matrix.os_name }}.zip
